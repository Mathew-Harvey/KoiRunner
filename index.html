<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Koi Runner</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Permanent+Marker&display=swap');

*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:#000;cursor:none;font-family:'Noto Sans JP',sans-serif;user-select:none}
canvas{display:block}

#cursor{position:fixed;width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,200,100,0.7);pointer-events:none;z-index:9999;transform:translate(-50%,-50%);box-shadow:0 0 12px rgba(255,150,50,0.3)}

#hud{position:fixed;top:0;left:0;width:100%;padding:18px 24px;display:flex;justify-content:space-between;align-items:flex-start;pointer-events:none;z-index:100;opacity:0;transition:opacity .6s}
#hud.visible{opacity:1}
.hud-left,.hud-right{display:flex;flex-direction:column;gap:6px}
.hud-center{text-align:center;position:absolute;left:50%;transform:translateX(-50%);top:18px}
.score-display{font-family:'Permanent Marker',cursive;font-size:32px;color:#FFD700;text-shadow:0 2px 12px rgba(255,215,0,.6),2px 2px 0 rgba(0,0,0,.7)}
.distance-display{font-family:'Permanent Marker',cursive;font-size:16px;color:#7ec8e3;text-shadow:0 1px 8px rgba(126,200,227,.5)}
.multiplier-display{font-family:'Permanent Marker',cursive;font-size:26px;color:#ff9f43;text-shadow:0 0 20px rgba(255,159,67,.7);transition:transform .15s;display:inline-block}
.multiplier-display.pulse{transform:scale(1.4)}
.lives-display{display:flex;gap:5px;align-items:center}
.lives-label{font-size:11px;color:rgba(255,255,255,.5);margin-right:4px;text-transform:uppercase;letter-spacing:1px}
.life-pip{width:14px;height:14px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ff6b6b,#e74c3c);box-shadow:0 0 6px rgba(231,76,60,.7);transition:all .3s}
.life-pip.lost{background:#222;box-shadow:none;opacity:.2;transform:scale(.7)}
.speed-bar-container{width:120px;height:6px;background:rgba(0,0,0,.6);border-radius:3px;border:1px solid rgba(255,255,255,.15);overflow:hidden}
.speed-bar{height:100%;background:linear-gradient(90deg,#00d2ff,#3a7bd5,#ff6b6b);border-radius:3px;transition:width .2s;box-shadow:0 0 6px rgba(0,210,255,.4)}
.speed-label{font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:2px}
.larvae-counter{font-family:'Permanent Marker',cursive;font-size:20px;color:#55efc4;text-shadow:0 0 10px rgba(85,239,196,.5)}

#menu-screen{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,#0a1628 0%,#0f3460 30%,#1a5276 60%,#2471a3 100%);transition:opacity 1s}
#menu-screen.hidden{opacity:0;pointer-events:none}
.menu-title{font-family:'Permanent Marker',cursive;font-size:clamp(48px,10vw,100px);background:linear-gradient(180deg,#FFD700 0%,#FF8C00 40%,#FF4500 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 6px 24px rgba(255,140,0,.5));animation:titleFloat 3s ease-in-out infinite;margin-bottom:8px;line-height:1.1}
@keyframes titleFloat{0%,100%{transform:translateY(0) rotate(-1deg)}50%{transform:translateY(-12px) rotate(1deg)}}
.menu-subtitle{font-size:16px;color:rgba(255,255,255,.5);margin-bottom:20px;letter-spacing:6px;text-transform:uppercase}
.menu-fish-area{width:240px;height:150px;margin-bottom:30px}
#menu-canvas{border-radius:12px;background:rgba(0,50,100,.3)}
.start-btn{font-family:'Permanent Marker',cursive;font-size:30px;padding:14px 55px;border:2px solid #FFD700;background:rgba(255,215,0,.08);color:#FFD700;cursor:pointer;border-radius:50px;transition:all .3s;letter-spacing:3px;text-shadow:0 0 15px rgba(255,215,0,.3)}
.start-btn:hover{background:rgba(255,215,0,.2);transform:scale(1.08);box-shadow:0 0 50px rgba(255,215,0,.25),inset 0 0 20px rgba(255,215,0,.1)}
.controls-info{margin-top:35px;color:rgba(255,255,255,.35);font-size:13px;text-align:center;line-height:2.2}
.controls-info span{color:rgba(255,215,0,.6);font-weight:700}
.menu-bubbles{position:absolute;inset:0;overflow:hidden;pointer-events:none}
.bubble{position:absolute;bottom:-30px;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.12),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.06);animation:bubbleRise linear infinite}
@keyframes bubbleRise{0%{transform:translateY(0) translateX(0) scale(.5);opacity:0}10%{opacity:.8;transform:scale(1)}90%{opacity:.6}100%{transform:translateY(-110vh) translateX(40px) scale(.3);opacity:0}}

#game-over{position:fixed;inset:0;z-index:300;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(5,10,20,.9);opacity:0;pointer-events:none;transition:opacity .6s;backdrop-filter:blur(12px)}
#game-over.visible{opacity:1;pointer-events:all}
.go-title{font-family:'Permanent Marker',cursive;font-size:68px;color:#e74c3c;text-shadow:0 0 40px rgba(231,76,60,.5),0 4px 0 rgba(0,0,0,.5);margin-bottom:24px}
.go-stats{text-align:center;margin-bottom:35px}
.go-stat{font-size:20px;color:#bbb;margin:10px 0}
.go-stat strong{color:#FFD700;font-family:'Permanent Marker',cursive;font-size:26px}
.go-best{color:#55efc4!important;font-size:15px!important;margin-top:16px!important}
.go-new-best{color:#ff6b6b!important;animation:pulse .5s ease infinite alternate}
@keyframes pulse{from{transform:scale(1)}to{transform:scale(1.05)}}
.retry-btn{font-family:'Permanent Marker',cursive;font-size:26px;padding:12px 45px;border:2px solid #FFD700;background:rgba(255,215,0,.08);color:#FFD700;cursor:pointer;border-radius:50px;transition:all .3s}
.retry-btn:hover{background:rgba(255,215,0,.2);transform:scale(1.08);box-shadow:0 0 40px rgba(255,215,0,.2)}
#flash-overlay{position:fixed;inset:0;z-index:150;pointer-events:none;opacity:0;transition:opacity .08s}
#flash-overlay.hit{background:radial-gradient(circle,rgba(255,50,50,.4),rgba(255,0,0,.15));opacity:1}
#flash-overlay.collect{background:radial-gradient(circle,rgba(85,239,196,.2),transparent 70%);opacity:1}
.combo-popup{position:fixed;z-index:160;pointer-events:none;font-family:'Permanent Marker',cursive;font-size:40px;color:#FFD700;text-shadow:0 0 25px rgba(255,215,0,.8),0 2px 0 rgba(0,0,0,.5);animation:comboFloat 1.2s ease-out forwards;left:50%;transform:translateX(-50%)}
@keyframes comboFloat{0%{transform:translateX(-50%) translateY(0) scale(.5);opacity:0}15%{transform:translateX(-50%) translateY(-10px) scale(1.2);opacity:1}100%{transform:translateX(-50%) translateY(-100px) scale(.8);opacity:0}}
#water-vignette{position:fixed;inset:0;pointer-events:none;z-index:50;background:radial-gradient(ellipse at 50% 50%,transparent 50%,rgba(0,20,60,.4) 100%)}
</style>
</head>
<body>
<div id="cursor"></div>
<div id="water-vignette"></div>
<div id="flash-overlay"></div>

<div id="hud">
  <div class="hud-left">
    <div class="score-display" id="score">0</div>
    <div class="distance-display" id="distance">0m</div>
    <div class="larvae-counter" id="larvae-display">&#x1FAB1; 0</div>
  </div>
  <div class="hud-center"><div class="multiplier-display" id="multiplier"></div></div>
  <div class="hud-right">
    <div class="lives-display" id="lives"></div>
    <div class="speed-label">Speed</div>
    <div class="speed-bar-container"><div class="speed-bar" id="speed-bar"></div></div>
  </div>
</div>

<div id="menu-screen">
  <div class="menu-bubbles" id="menu-bubbles"></div>
  <div class="menu-title">Koi Runner</div>
  <div class="menu-subtitle">Navigate the River</div>
  <div class="menu-fish-area"><canvas id="menu-canvas" width="240" height="150"></canvas></div>
  <button class="start-btn" id="start-btn">DIVE IN</button>
  <div class="controls-info">
    <span>WASD</span> to swim &nbsp;|&nbsp; <span>MOUSE</span> to look<br>
    <span>SHIFT</span> to sprint &nbsp;|&nbsp; <span>SPACE</span> to jump<br>
    Collect larvae &#x1FAB1; &nbsp;|&nbsp; Dodge obstacles &nbsp;|&nbsp; Survive!
  </div>
</div>

<div id="game-over">
  <div class="go-title">GAME OVER</div>
  <div class="go-stats">
    <div class="go-stat">Score: <strong id="final-score">0</strong></div>
    <div class="go-stat">Distance: <strong id="final-distance">0m</strong></div>
    <div class="go-stat">Larvae: <strong id="final-larvae">0</strong></div>
    <div class="go-stat go-best" id="best-score-display"></div>
  </div>
  <button class="retry-btn" id="retry-btn">SWIM AGAIN</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// =====================================================================
// KOI RUNNER v3 â€” Full 3D Koi Fish Model
// =====================================================================

// -- AUDIO --
const AudioCtx=window.AudioContext||window.webkitAudioContext;let audioCtx;
function initAudio(){if(!audioCtx)audioCtx=new AudioCtx()}
function playSound(type){if(!audioCtx)return;try{const now=audioCtx.currentTime;
if(type==='collect'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';o.frequency.setValueAtTime(600,now);o.frequency.exponentialRampToValueAtTime(1200,now+.1);g.gain.setValueAtTime(.15,now);g.gain.exponentialRampToValueAtTime(.001,now+.25);o.start(now);o.stop(now+.25)}
else if(type==='hit'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sawtooth';o.frequency.setValueAtTime(200,now);o.frequency.exponentialRampToValueAtTime(50,now+.3);g.gain.setValueAtTime(.2,now);g.gain.exponentialRampToValueAtTime(.001,now+.3);o.start(now);o.stop(now+.3)}
else if(type==='splash'){const n=audioCtx.sampleRate*.15,b=audioCtx.createBuffer(1,n,audioCtx.sampleRate),d=b.getChannelData(0);for(let i=0;i<n;i++)d[i]=(Math.random()*2-1)*(1-i/n);const s=audioCtx.createBufferSource(),g=audioCtx.createGain(),f=audioCtx.createBiquadFilter();f.type='lowpass';f.frequency.value=2000;s.buffer=b;s.connect(f);f.connect(g);g.connect(audioCtx.destination);g.gain.setValueAtTime(.08,now);g.gain.exponentialRampToValueAtTime(.001,now+.15);s.start(now)}
else if(type==='combo'){[800,1000,1300].forEach((freq,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';o.frequency.value=freq;g.gain.setValueAtTime(0,now+i*.08);g.gain.linearRampToValueAtTime(.1,now+i*.08+.02);g.gain.exponentialRampToValueAtTime(.001,now+i*.08+.15);o.start(now+i*.08);o.stop(now+i*.08+.15)})}
else if(type==='jump'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.type='sine';o.frequency.setValueAtTime(300,now);o.frequency.exponentialRampToValueAtTime(800,now+.15);g.gain.setValueAtTime(.1,now);g.gain.exponentialRampToValueAtTime(.001,now+.2);o.start(now);o.stop(now+.2)}}catch(e){}}

// -- GLOBALS --
let scene,camera,renderer,clock;
let koiGroup;
let river={segments:[],width:18};
let obstacles=[],larvaList=[],particles=[];
let waterPlane,gameState='menu';
let score=0,distance=0,larvaeCount=0,lives=3,multiplier=1;
let comboTimer=0,comboCount=0;
let baseSpeed=11,maxSpeed=28,currentSpeed=11;
let isSprinting=false,isJumping=false,jumpVelocity=0;
let playerPos={x:0,y:-0.3,z:0},playerVel={x:0,y:0};
let mouseX=0,mouseY=0,keys={};
let invincibleTimer=0;
let bestScore=parseInt(localStorage.getItem('koiRunnerBest')||'0');
let tailTime=0,spawnTimer=0,larvaSpawnTimer=0,difficultyTimer=0;
let obstacleFrequency=0.55,screenShake=0;
let ambientLights=[],lightRays=[];
const SL=22,VD=220,CD=40;
let nextSegmentZ=0;

// -- MENU BUBBLES --
!function(){const c=document.getElementById('menu-bubbles');for(let i=0;i<25;i++){const b=document.createElement('div');b.className='bubble';const s=4+Math.random()*35;b.style.width=s+'px';b.style.height=s+'px';b.style.left=Math.random()*100+'%';b.style.animationDuration=(5+Math.random()*12)+'s';b.style.animationDelay=Math.random()*8+'s';c.appendChild(b)}}();

// -- ANIMATED MENU KOI (canvas 2D preview) --
!function(){
const cv=document.getElementById('menu-canvas'),cx=cv.getContext('2d');let t=0;
function draw(){
  cx.clearRect(0,0,240,150);
  const ox=120+Math.sin(t*.4)*20,oy=75+Math.sin(t*.7)*10;
  const ta=Math.sin(t*2)*.3;
  cx.save();cx.translate(ox,oy);
  // Outline
  cx.beginPath();cx.ellipse(0,0,55,26,0,0,Math.PI*2);cx.fillStyle='#111';cx.fill();
  // White body
  cx.beginPath();cx.ellipse(0,0,50,22,0,0,Math.PI*2);cx.fillStyle='#f5f0e8';cx.fill();
  // Orange patches
  cx.fillStyle='#FF6B20';
  cx.beginPath();cx.ellipse(16,-5,20,12,.3,0,Math.PI*2);cx.fill();
  cx.beginPath();cx.ellipse(-8,7,14,9,-.2,0,Math.PI*2);cx.fill();
  cx.beginPath();cx.ellipse(28,8,9,7,.5,0,Math.PI*2);cx.fill();
  cx.beginPath();cx.ellipse(-5,-9,8,5,-.3,0,Math.PI*2);cx.fill();
  cx.beginPath();cx.ellipse(5,3,6,4,.1,0,Math.PI*2);cx.fill();
  // Tail
  cx.save();cx.translate(48,0);cx.rotate(ta);
  cx.fillStyle='#FF6B20';cx.strokeStyle='#111';cx.lineWidth=2;
  cx.beginPath();cx.moveTo(0,-3);cx.quadraticCurveTo(28,-18,22,-32);cx.lineTo(5,-6);cx.closePath();cx.fill();cx.stroke();
  cx.beginPath();cx.moveTo(0,3);cx.quadraticCurveTo(28,18,22,32);cx.lineTo(5,6);cx.closePath();cx.fill();cx.stroke();
  // Tail stripes
  cx.strokeStyle='#333';cx.lineWidth=1;
  for(let i=0;i<4;i++){cx.beginPath();cx.moveTo(3,-3+i*-5);cx.lineTo(18,-10+i*-5);cx.stroke();cx.beginPath();cx.moveTo(3,3+i*5);cx.lineTo(18,10+i*5);cx.stroke()}
  cx.restore();
  // Dorsal fin
  cx.save();cx.translate(10,-20);
  cx.beginPath();cx.moveTo(0,0);cx.quadraticCurveTo(10,-22,0,-16);cx.quadraticCurveTo(-8,-18,-18,0);cx.closePath();cx.fillStyle='#FF6B20';cx.fill();cx.strokeStyle='#111';cx.lineWidth=2;cx.stroke();
  cx.strokeStyle='#333';cx.lineWidth=1;for(let i=0;i<4;i++){cx.beginPath();cx.moveTo(-2-i*3,-1-i*2);cx.lineTo(0-i*2,-12-i);cx.stroke()}
  cx.restore();
  // Pectoral fins
  cx.save();cx.translate(-8,18);
  cx.beginPath();cx.moveTo(0,0);cx.quadraticCurveTo(18,14,10,22);cx.quadraticCurveTo(-2,12,0,0);cx.closePath();cx.fillStyle='#FF6B20';cx.fill();cx.strokeStyle='#111';cx.lineWidth=1.5;cx.stroke();
  cx.strokeStyle='#333';cx.lineWidth=1;for(let i=0;i<3;i++){cx.beginPath();cx.moveTo(2+i*3,2+i*3);cx.lineTo(8+i*2,12+i*2);cx.stroke()}
  cx.restore();
  // Body outline
  cx.beginPath();cx.ellipse(0,0,50,22,0,0,Math.PI*2);cx.strokeStyle='#111';cx.lineWidth=3;cx.stroke();
  // Eye
  cx.beginPath();cx.arc(-30,-2,10,0,Math.PI*2);cx.fillStyle='#FF8C00';cx.fill();cx.strokeStyle='#111';cx.lineWidth=2.5;cx.stroke();
  cx.beginPath();cx.arc(-30,-2,5,0,Math.PI*2);cx.fillStyle='#111';cx.fill();
  cx.beginPath();cx.arc(-31.5,-3.5,2,0,Math.PI*2);cx.fillStyle='#fff';cx.fill();
  // Whiskers
  cx.strokeStyle='#222';cx.lineWidth=2;
  cx.beginPath();cx.moveTo(-48,4);cx.quadraticCurveTo(-65,16,-78,14+Math.sin(t*1.5)*4);cx.stroke();
  cx.beginPath();cx.moveTo(-48,9);cx.quadraticCurveTo(-62,24,-76,28+Math.sin(t*1.5+1)*4);cx.stroke();
  // Mouth
  cx.beginPath();cx.arc(-48,5,3,0,Math.PI*2);cx.fillStyle='#555';cx.fill();
  cx.restore();
  t+=0.016;requestAnimationFrame(draw);
}draw()}();

// -- CURSOR --
const cursor=document.getElementById('cursor');
document.addEventListener('mousemove',e=>{cursor.style.left=e.clientX+'px';cursor.style.top=e.clientY+'px';if(gameState==='playing'){mouseX=(e.clientX/window.innerWidth-.5)*2;mouseY=(e.clientY/window.innerHeight-.5)*2}});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  3D KOI MODEL - matches the drawing exactly
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createKoi3D(){
  koiGroup=new THREE.Group();

  const whiteMat=new THREE.MeshPhongMaterial({color:0xf5f0e8,shininess:60,specular:0xffffff});
  const orangeMat=new THREE.MeshPhongMaterial({color:0xFF6B20,shininess:50,specular:0xffaa66,emissive:0x331100,emissiveIntensity:.1});
  const dkOrangeMat=new THREE.MeshPhongMaterial({color:0xE05510,shininess:40,specular:0xff8844});
  const outlineMat=new THREE.MeshBasicMaterial({color:0x111111,side:THREE.BackSide});
  const finMat=new THREE.MeshPhongMaterial({color:0xFF6B20,shininess:40,transparent:true,opacity:.92,side:THREE.DoubleSide});
  const stripeMat=new THREE.MeshPhongMaterial({color:0x222222,shininess:20,side:THREE.DoubleSide});

  // OUTLINE SHELL (toon outline via back-face)
  const olGeo=new THREE.SphereGeometry(1,20,14);olGeo.scale(1.08,.52,2.35);
  koiGroup.add(new THREE.Mesh(olGeo,outlineMat));

  // WHITE BODY
  const bGeo=new THREE.SphereGeometry(1,20,14);bGeo.scale(1,.48,2.3);
  const body=new THREE.Mesh(bGeo,whiteMat);body.castShadow=true;body.name='body';
  koiGroup.add(body);

  // HEAD
  const hGeo=new THREE.SphereGeometry(.55,14,10);hGeo.scale(1,.85,1.1);
  koiGroup.add(new THREE.Mesh(hGeo,whiteMat).translateZ(-1.65).translateY(.02));
  const hoGeo=new THREE.SphereGeometry(.58,14,10);hoGeo.scale(1.02,.88,1.12);
  koiGroup.add(new THREE.Mesh(hoGeo,outlineMat).translateZ(-1.65).translateY(.02));

  // MOUTH
  const moGeo=new THREE.SphereGeometry(.1,8,6);moGeo.scale(1,.5,1);
  koiGroup.add(new THREE.Mesh(moGeo,new THREE.MeshPhongMaterial({color:0x444444})).translateZ(-2.25).translateY(-.1));

  // ORANGE PATCHES (6 patches matching the drawing)
  const patches=[
    {s:[1,.5,1.5],p:[.15,.18,.3],r:0,m:orangeMat},
    {s:[.9,.5,1.2],p:[-.2,-.08,-.5],r:0,m:orangeMat},
    {s:[.8,.5,1],p:[.25,.15,1.2],r:0,m:dkOrangeMat},
    {s:[.8,.5,.9],p:[-.15,.12,-1.1],r:0,m:orangeMat},
    {s:[.7,.45,1.1],p:[.1,-.15,0],r:0,m:dkOrangeMat},
    {s:[.6,.35,.8],p:[.05,.22,-.2],r:0,m:orangeMat},
  ];
  patches.forEach(({s,p,m})=>{
    const g=new THREE.SphereGeometry(.5,10,8);g.scale(s[0],s[1],s[2]);
    koiGroup.add(new THREE.Mesh(g,m).translateX(p[0]).translateY(p[1]).translateZ(p[2]));
  });

  // EYES (prominent, matching drawing)
  [-1,1].forEach(side=>{
    // Orange ring
    const erGeo=new THREE.SphereGeometry(.18,12,10);erGeo.scale(1,1,.7);
    koiGroup.add(new THREE.Mesh(erGeo,new THREE.MeshPhongMaterial({color:0xFF8C00,shininess:80,specular:0xffcc44})).translateX(side*.42).translateY(.08).translateZ(-1.7));
    // Black outline ring
    const eoGeo=new THREE.SphereGeometry(.21,12,10);eoGeo.scale(1,1,.5);
    const eoMesh=new THREE.Mesh(eoGeo,new THREE.MeshBasicMaterial({color:0x111111}));
    eoMesh.position.set(side*.44,.08,-1.7);koiGroup.add(eoMesh);
    // Orange iris
    const iGeo=new THREE.SphereGeometry(.17,12,10);iGeo.scale(1,1,.5);
    koiGroup.add(new THREE.Mesh(iGeo,new THREE.MeshPhongMaterial({color:0xFF8C00,shininess:80})).translateX(side*.46).translateY(.08).translateZ(-1.72));
    // Black pupil
    const pGeo=new THREE.SphereGeometry(.09,10,8);pGeo.scale(1,1,.5);
    koiGroup.add(new THREE.Mesh(pGeo,new THREE.MeshPhongMaterial({color:0x111111,shininess:200,specular:0xffffff})).translateX(side*.48).translateY(.09).translateZ(-1.78));
    // White highlight
    koiGroup.add(new THREE.Mesh(new THREE.SphereGeometry(.035,6,6),new THREE.MeshPhongMaterial({color:0xffffff,emissive:0xffffff,emissiveIntensity:.3})).translateX(side*.46).translateY(.13).translateZ(-1.81));
  });

  // WHISKERS (curved tubes)
  [-1,1].forEach(side=>{
    const curve=new THREE.QuadraticBezierCurve3(
      new THREE.Vector3(side*.12,-.15,-2.1),
      new THREE.Vector3(side*.5,-.05-side*.12,-2.8),
      new THREE.Vector3(side*.7,-.08+side*.08,-3.3)
    );
    const w=new THREE.Mesh(new THREE.TubeGeometry(curve,12,.018,4,false),new THREE.MeshPhongMaterial({color:0x222222,shininess:30}));
    w.name='whisker';koiGroup.add(w);
  });

  // DORSAL FIN (orange with stripes)
  const dorsalGrp=new THREE.Group();dorsalGrp.name='dorsalFin';
  const ds=new THREE.Shape();
  ds.moveTo(0,0);ds.quadraticCurveTo(.15,.75,.05,.95);ds.quadraticCurveTo(-.05,1,-.1,.85);ds.quadraticCurveTo(-.2,.5,-.65,.15);ds.lineTo(-.75,0);ds.closePath();
  const dGeo=new THREE.ExtrudeGeometry(ds,{depth:.03,bevelEnabled:true,bevelThickness:.01,bevelSize:.01,bevelSegments:2});
  const dMesh=new THREE.Mesh(dGeo,finMat);dMesh.rotation.y=Math.PI/2;dorsalGrp.add(dMesh);
  for(let i=0;i<5;i++){const sg=new THREE.Mesh(new THREE.BoxGeometry(.01,.45-i*.06,.04),stripeMat);sg.position.set(0,.28+i*.06,-.1-i*.12);sg.rotation.z=.08+i*.07;dorsalGrp.add(sg)}
  dorsalGrp.position.set(0,.44,0);dorsalGrp.scale.set(1.2,1,1.2);
  koiGroup.add(dorsalGrp);

  // PECTORAL FINS (sides, orange with stripes)
  [-1,1].forEach(side=>{
    const pg=new THREE.Group();pg.name='pectoral_'+(side>0?'R':'L');
    const ps=new THREE.Shape();ps.moveTo(0,0);ps.quadraticCurveTo(.7,.15,.6,-.35);ps.quadraticCurveTo(.3,-.15,0,0);
    const pGeo=new THREE.ExtrudeGeometry(ps,{depth:.02,bevelEnabled:true,bevelThickness:.005,bevelSize:.005,bevelSegments:1});
    pg.add(new THREE.Mesh(pGeo,finMat));
    for(let i=0;i<3;i++){const s=new THREE.Mesh(new THREE.BoxGeometry(.3-i*.06,.008,.02),stripeMat);s.position.set(.22-i*.04,-.04-i*.06,.01);s.rotation.z=-.15-i*.15;pg.add(s)}
    pg.position.set(side*.75,-.12,-.9);pg.rotation.set(.2,side*.6,side*(-.4));pg.scale.set(.8,.8,.8);
    koiGroup.add(pg);
  });

  // VENTRAL FINS
  [-1,1].forEach(side=>{
    const vs=new THREE.Shape();vs.moveTo(0,0);vs.quadraticCurveTo(.3,.08,.25,-.2);vs.quadraticCurveTo(.1,-.08,0,0);
    const vf=new THREE.Mesh(new THREE.ShapeGeometry(vs),finMat);
    vf.position.set(side*.35,-.35,.5);vf.rotation.set(.3,side*.3,side*(-.2));vf.name='ventralFin';koiGroup.add(vf);
  });

  // ANAL FIN
  const as=new THREE.Shape();as.moveTo(0,0);as.quadraticCurveTo(.08,.35,-.05,.4);as.quadraticCurveTo(-.15,.2,-.35,0);as.closePath();
  const af=new THREE.Mesh(new THREE.ExtrudeGeometry(as,{depth:.02,bevelEnabled:false}),finMat);
  af.position.set(0,-.38,.8);af.rotation.set(Math.PI,Math.PI/2,0);koiGroup.add(af);

  // TAIL FIN (large fan, key feature!)
  const tailGrp=new THREE.Group();tailGrp.name='tailFin';
  // Upper lobe
  const tus=new THREE.Shape();tus.moveTo(0,0);tus.quadraticCurveTo(.85,-.15,1.15,-.55);tus.quadraticCurveTo(1,-.75,.7,-.85);tus.quadraticCurveTo(.3,-.4,0,-.05);tus.closePath();
  tailGrp.add(new THREE.Mesh(new THREE.ExtrudeGeometry(tus,{depth:.03,bevelEnabled:true,bevelThickness:.008,bevelSize:.008,bevelSegments:1}),finMat).translateY(.15));
  // Lower lobe
  const tls=new THREE.Shape();tls.moveTo(0,0);tls.quadraticCurveTo(.85,.15,1.15,.55);tls.quadraticCurveTo(1,.75,.7,.85);tls.quadraticCurveTo(.3,.4,0,.05);tls.closePath();
  tailGrp.add(new THREE.Mesh(new THREE.ExtrudeGeometry(tls,{depth:.03,bevelEnabled:true,bevelThickness:.008,bevelSize:.008,bevelSegments:1}),finMat).translateY(-.15));
  // Tail outline
  const tos=new THREE.Shape();tos.moveTo(-.05,.2);tos.quadraticCurveTo(.9,-.2,1.25,-.65);tos.quadraticCurveTo(1.15,-.9,.7,-.95);tos.lineTo(0,-.1);tos.lineTo(-.05,-.15);tos.lineTo(0,.1);tos.lineTo(.7,.95);tos.quadraticCurveTo(1.15,.9,1.25,.65);tos.quadraticCurveTo(.9,.2,-.05,.2);
  tailGrp.add(new THREE.Mesh(new THREE.ExtrudeGeometry(tos,{depth:.005,bevelEnabled:false}),new THREE.MeshBasicMaterial({color:0x111111,side:THREE.DoubleSide})).translateZ(-.01));
  // Tail stripes
  for(let i=0;i<6;i++){const a=(i-2.5)*.22,l=.55+Math.abs(i-2.5)*.08;const s=new THREE.Mesh(new THREE.BoxGeometry(l,.01,.035),stripeMat);s.position.set(.35+i*.04,a*.5,.015);s.rotation.z=a*.55;tailGrp.add(s)}
  tailGrp.position.set(0,0,2.05);tailGrp.rotation.y=Math.PI/2;tailGrp.scale.set(1.15,1,1.15);
  koiGroup.add(tailGrp);

  // GLOW
  const glGeo=new THREE.SphereGeometry(1.6,12,8);glGeo.scale(1,.5,2.3);
  const gl=new THREE.Mesh(glGeo,new THREE.MeshBasicMaterial({color:0xFF8C00,transparent:true,opacity:.06,depthWrite:false}));
  gl.name='glow';koiGroup.add(gl);

  // SHADOW
  const sh=new THREE.Mesh(new THREE.PlaneGeometry(2.5,4),new THREE.MeshBasicMaterial({color:0x000000,transparent:true,opacity:.12,depthWrite:false}));
  sh.rotation.x=-Math.PI/2;sh.name='fishShadow';koiGroup.add(sh);

  koiGroup.scale.set(.55,.55,.55);
  koiGroup.rotation.y=Math.PI;
  scene.add(koiGroup);
}

// -- KOI ANIMATION --
function updateKoi(dt,time){
  if(!koiGroup)return;
  tailTime+=dt*(4+currentSpeed*.3);
  const sf=tailTime;
  koiGroup.position.set(playerPos.x,playerPos.y+.5,playerPos.z);
  const bw=Math.sin(sf)*.04;
  koiGroup.rotation.z=bw+playerVel.x*-.06;
  koiGroup.rotation.x=(jumpVelocity*.04)+Math.sin(time*1.8)*.015;
  koiGroup.rotation.z+=playerVel.x*-.04;

  koiGroup.traverse(c=>{
    if(c.name==='tailFin'){c.rotation.x=Math.sin(sf*1.3)*.35;c.position.x=Math.sin(sf*1.3)*.05}
    if(c.name==='dorsalFin')c.rotation.z=Math.sin(sf*.8)*.06;
    if(c.name==='pectoral_R')c.rotation.z=-.4+Math.sin(sf+.5)*.2;
    if(c.name==='pectoral_L')c.rotation.z=.4+Math.sin(sf+1.5)*.2;
    if(c.name==='ventralFin')c.rotation.x=.3+Math.sin(sf*.9)*.1;
    if(c.name==='glow'){c.material.opacity=.04+Math.sin(time*3)*.02;if(invincibleTimer>0){c.material.opacity=.12+Math.sin(time*15)*.08;c.material.color.setHex(0x4488ff)}else c.material.color.setHex(0xFF8C00)}
    if(c.name==='fishShadow'){c.position.set(0,-.5/.55-playerPos.y/.55+.3,0);c.material.opacity=.08+(1-Math.max(0,playerPos.y)/3)*.08;const s=1+Math.max(0,playerPos.y)*.15;c.scale.set(s,s,1)}
  });
  if(invincibleTimer>0)koiGroup.visible=Math.sin(invincibleTimer*18)>0;else koiGroup.visible=true;
}

// -- SCENE --
function initScene(){
  scene=new THREE.Scene();scene.background=new THREE.Color(0x0a1e3d);scene.fog=new THREE.FogExp2(0x0d2847,.005);
  camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,600);camera.position.set(0,5.5,8);
  renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(window.innerWidth,window.innerHeight);renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.3;
  document.body.insertBefore(renderer.domElement,document.body.firstChild);clock=new THREE.Clock();

  scene.add(new THREE.AmbientLight(0x4499cc,.8));
  const sun=new THREE.DirectionalLight(0xffeedd,1);sun.position.set(15,50,-20);sun.castShadow=true;
  sun.shadow.mapSize.set(2048,2048);sun.shadow.camera.near=1;sun.shadow.camera.far=200;
  sun.shadow.camera.left=-40;sun.shadow.camera.right=40;sun.shadow.camera.top=40;sun.shadow.camera.bottom=-40;
  scene.add(sun);
  for(let i=0;i<4;i++){const pl=new THREE.PointLight(0x33aadd,.4,35);pl.position.set(0,4,-i*30);scene.add(pl);ambientLights.push(pl)}
  for(let i=0;i<5;i++){const r=new THREE.Mesh(new THREE.PlaneGeometry(.5+Math.random()*1.5,15),new THREE.MeshBasicMaterial({color:0x88ccff,transparent:true,opacity:.04,side:THREE.DoubleSide,depthWrite:false}));r.position.set((Math.random()-.5)*12,5,-30-i*20);r.rotation.z=(Math.random()-.5)*.3;r.rotation.y=Math.random()*Math.PI;scene.add(r);lightRays.push(r)}
  const bl=new THREE.DirectionalLight(0x0055aa,.25);bl.position.set(0,-8,-5);scene.add(bl);

  createWater();createKoi3D();createInitialRiver();updateLivesDisplay();
}

// -- WATER --
function createWater(){
  const g=new THREE.PlaneGeometry(70,500,70,120);
  waterPlane=new THREE.Mesh(g,new THREE.MeshPhongMaterial({color:0x1a75c7,transparent:true,opacity:.32,shininess:120,specular:0x99ddff,side:THREE.DoubleSide,depthWrite:false}));
  waterPlane.rotation.x=-Math.PI/2;waterPlane.position.y=1.8;scene.add(waterPlane);
}
function animateWater(time){if(!waterPlane)return;const p=waterPlane.geometry.attributes.position;for(let i=0;i<p.count;i++){const x=p.getX(i),y=p.getY(i);p.setZ(i,Math.sin(x*.25+time*1.8)*.35+Math.sin(y*.18+time*1.3)*.25+Math.cos((x+y)*.4+time*2.5)*.12)}p.needsUpdate=true;waterPlane.position.z=playerPos.z-200}

// -- RIVER --
function createRiverSegment(z){
  const seg=new THREE.Group();seg.position.z=z;
  const bedGeo=new THREE.PlaneGeometry(river.width+6,SL,24,12);const bP=bedGeo.attributes.position;
  for(let i=0;i<bP.count;i++)bP.setZ(i,Math.sin(bP.getX(i)*.4)*.3+Math.random()*.12);bedGeo.computeVertexNormals();
  seg.add(new THREE.Mesh(bedGeo,new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.42,.35,.18+Math.random()*.06),shininess:8})).rotateX(-Math.PI/2).translateZ(2.2));

  [-1,1].forEach(side=>{
    const bm=new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.28+Math.random()*.06,.45,.2+Math.random()*.08),flatShading:true});
    const bank=new THREE.Mesh(new THREE.BoxGeometry(7,5,SL+1),bm);bank.position.set(side*(river.width/2+3.5),-.5,0);bank.receiveShadow=true;bank.castShadow=true;seg.add(bank);
    for(let i=0;i<4;i++){const rG=new THREE.Group();for(let r=0;r<3+Math.floor(Math.random()*5);r++){const h=1.2+Math.random()*2.2;const reed=new THREE.Mesh(new THREE.CylinderGeometry(.02,.04,h,3),new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.27+Math.random()*.08,.55,.28+Math.random()*.15)}));reed.position.set((Math.random()-.5)*.6,h/2,(Math.random()-.5)*.4);reed.rotation.z=(Math.random()-.5)*.25;rG.add(reed)}rG.position.set(side*(river.width/2+.3+Math.random()*2.5),1.2,-SL/2+Math.random()*SL);rG.userData.swayOffset=Math.random()*6.28;rG.name='reeds';seg.add(rG)}
    if(Math.random()<.65){for(let t=0;t<1+Math.floor(Math.random()*2);t++){const tree=new THREE.Group();const trH=2.5+Math.random()*2;tree.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.22,trH,6),new THREE.MeshPhongMaterial({color:0x4a3020,flatShading:true})).translateY(trH/2));const isC=Math.random()<.3;for(let f=0;f<3;f++){const fo=new THREE.Mesh(new THREE.IcosahedronGeometry(1-.2*f-Math.random()*.2,1),new THREE.MeshPhongMaterial({color:isC?new THREE.Color().setHSL(.93+Math.random()*.05,.5,.6+Math.random()*.15):new THREE.Color().setHSL(.27+Math.random()*.08,.5,.22+Math.random()*.12),flatShading:true}));fo.position.set((Math.random()-.5)*.5,trH+f*.7,(Math.random()-.5)*.5);fo.castShadow=true;tree.add(fo)}tree.position.set(side*(river.width/2+3+Math.random()*4),.5,-SL/2+Math.random()*SL);tree.scale.setScalar(.7+Math.random()*.7);seg.add(tree)}}
    for(let r=0;r<2+Math.floor(Math.random()*3);r++){const rock=new THREE.Mesh(new THREE.DodecahedronGeometry(.2+Math.random()*.5,1),new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(0,0,.28+Math.random()*.2),flatShading:true}));rock.position.set(side*(river.width/2+Math.random()*1.5),1.3+Math.random()*.4,-SL/2+Math.random()*SL);rock.rotation.set(Math.random()*3,Math.random()*3,Math.random()*3);rock.scale.y=.5+Math.random()*.5;rock.castShadow=true;seg.add(rock)}
  });
  for(let i=0;i<15;i++){const p=new THREE.Mesh(new THREE.SphereGeometry(.06+Math.random()*.12,5,4),new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.08+Math.random()*.05,.15,.3+Math.random()*.3),flatShading:true}));p.position.set((Math.random()-.5)*river.width,-1.9,-SL/2+Math.random()*SL);p.scale.y=.4;seg.add(p)}
  for(let i=0;i<3+Math.floor(Math.random()*3);i++){const sw=new THREE.Group();for(let s=0;s<3+Math.floor(Math.random()*3);s++){sw.add(new THREE.Mesh(new THREE.CylinderGeometry(.03,.05,.5+Math.random()*.3,4),new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.32+Math.random()*.08,.65,.22+Math.random()*.1),transparent:true,opacity:.85})).translateY(s*.45).rotateZ(Math.sin(s*.8)*.15))}sw.position.set((Math.random()-.5)*(river.width-3),-1.7,-SL/2+Math.random()*SL);sw.userData.swayOffset=Math.random()*6.28;sw.name='seaweed';seg.add(sw)}
  if(Math.random()<.4){for(let l=0;l<1+Math.floor(Math.random()*3);l++){const pad=new THREE.Mesh(new THREE.CircleGeometry(.4+Math.random()*.35,10),new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.33,.75,.28+Math.random()*.1),side:THREE.DoubleSide,shininess:60}));pad.rotation.x=-Math.PI/2;pad.position.set((Math.random()-.5)*(river.width-6),.6+Math.random()*.1,-SL/2+Math.random()*SL);pad.userData.bobOffset=Math.random()*6.28;pad.name='lilypad';seg.add(pad)}}
  seg.userData.z=z;scene.add(seg);river.segments.push(seg);
}
function createInitialRiver(){nextSegmentZ=50;for(let z=50;z>-VD;z-=SL){createRiverSegment(z);nextSegmentZ=z-SL}}

// -- OBSTACLES --
function createObstacle(z){
  const types=['boulder','log','whirlpool','heron','net'];const type=types[Math.floor(Math.random()*types.length)];let obj,hr;
  if(type==='boulder'){obj=new THREE.Group();const sz=.7+Math.random()*.9;const g=new THREE.DodecahedronGeometry(sz,2);const vP=g.attributes.position;for(let i=0;i<vP.count;i++){const n=.85+Math.random()*.3;vP.setXYZ(i,vP.getX(i)*n,vP.getY(i)*n*.7,vP.getZ(i)*n)}g.computeVertexNormals();obj.add(new THREE.Mesh(g,new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.06,.15,.25+Math.random()*.15),flatShading:true,shininess:25})));if(Math.random()<.5){const m=new THREE.Mesh(new THREE.SphereGeometry(sz*.6,8,6),new THREE.MeshPhongMaterial({color:0x2d5a27,flatShading:true,transparent:true,opacity:.7}));m.position.y=sz*.3;m.scale.y=.3;obj.add(m)}hr=sz*.85;obj.position.y=-.6}
  else if(type==='log'){obj=new THREE.Group();const len=3+Math.random()*3,rad=.2+Math.random()*.15;const lm=new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.07,.4,.22+Math.random()*.1),flatShading:true});const log=new THREE.Mesh(new THREE.CylinderGeometry(rad*.8,rad,len,8),lm);log.rotation.z=Math.PI/2+(Math.random()-.5)*.4;log.castShadow=true;obj.add(log);for(let b=0;b<3;b++){const br=new THREE.Mesh(new THREE.CylinderGeometry(.02,.06,.6+Math.random()*.5,4),lm);br.position.set((Math.random()-.5)*len*.3,rad+.2,0);br.rotation.z=(Math.random()-.5)*.8;obj.add(br)}hr=len/2*.6;obj.position.y=-.1}
  else if(type==='whirlpool'){obj=new THREE.Group();for(let r=0;r<4;r++){const ring=new THREE.Mesh(new THREE.TorusGeometry(.6+r*.4,.06,6,16),new THREE.MeshPhongMaterial({color:0x2299cc,transparent:true,opacity:.35-r*.06,emissive:0x115577,emissiveIntensity:.4}));ring.rotation.x=Math.PI/2;ring.position.y=-r*.3;ring.name='whirlRing';ring.userData.ringIndex=r;obj.add(ring)}const v=new THREE.Mesh(new THREE.ConeGeometry(.3,2,8,1,true),new THREE.MeshPhongMaterial({color:0x0066aa,transparent:true,opacity:.25,side:THREE.DoubleSide,emissive:0x003366,emissiveIntensity:.3}));v.position.y=-1;obj.add(v);hr=1.6;obj.position.y=.2}
  else if(type==='heron'){obj=new THREE.Group();const hm=new THREE.MeshPhongMaterial({color:0xcccccc,flatShading:true});const bd=new THREE.Mesh(new THREE.ConeGeometry(.3,1.2,6),hm);bd.position.y=1.5;bd.castShadow=true;obj.add(bd);const hd=new THREE.Mesh(new THREE.SphereGeometry(.18,6,6),hm);hd.position.set(0,2.2,-.15);obj.add(hd);const bk=new THREE.Mesh(new THREE.ConeGeometry(.04,.5,4),new THREE.MeshPhongMaterial({color:0xcc8833}));bk.rotation.x=Math.PI/2+.5;bk.position.set(0,2,-.35);obj.add(bk);[-0.1,0.1].forEach(x=>{const lg=new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,1.5,4),new THREE.MeshPhongMaterial({color:0x886644}));lg.position.set(x,.6,0);obj.add(lg)});[-1,1].forEach(s=>{const w=new THREE.Mesh(new THREE.PlaneGeometry(.8,.6),new THREE.MeshPhongMaterial({color:0x999999,side:THREE.DoubleSide,flatShading:true}));w.position.set(s*.4,1.6,0);w.rotation.z=s*-.3;w.name='heronWing';w.userData.side=s;obj.add(w)});hr=1;obj.position.y=-.8}
  else{obj=new THREE.Group();const nm=new THREE.Mesh(new THREE.SphereGeometry(1.3,8,6,0,Math.PI*2,0,Math.PI*.7),new THREE.MeshPhongMaterial({color:0x998866,wireframe:true,transparent:true,opacity:.55}));nm.scale.y=.5;obj.add(nm);const hl=new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,4.5,4),new THREE.MeshPhongMaterial({color:0x664422}));hl.position.set(1.3,2,0);hl.rotation.z=-.35;obj.add(hl);const rng=new THREE.Mesh(new THREE.TorusGeometry(1.3,.04,8,16),new THREE.MeshPhongMaterial({color:0x554433}));rng.rotation.x=Math.PI/2;rng.position.y=.05;obj.add(rng);hr=1.5;obj.position.y=-.2}
  const lanes=5,lw=(river.width-4)/lanes,lane=Math.floor(Math.random()*lanes);
  obj.position.x=-((river.width-4)/2)+lane*lw+lw/2+(Math.random()-.5)*(lw*.4);
  obj.position.z=z;obj.userData.hitRadius=hr;obj.userData.type='obstacle';obj.userData.obstacleType=type;
  scene.add(obj);obstacles.push(obj);
}

// -- LARVAE --
function createLarva(z,x){
  const grp=new THREE.Group();
  for(let s=0;s<6;s++){const t=s/5,r=.09+Math.sin(t*Math.PI)*.06;grp.add(new THREE.Mesh(new THREE.SphereGeometry(r,8,6),new THREE.MeshPhongMaterial({color:new THREE.Color().setHSL(.25+t*.08,.8,.45+t*.1),emissive:new THREE.Color().setHSL(.3,.5,.15),emissiveIntensity:.4,shininess:60})).translateZ(s*.14))}
  const gl=new THREE.Mesh(new THREE.RingGeometry(.3,.5,16),new THREE.MeshBasicMaterial({color:0x66ff66,transparent:true,opacity:.12,side:THREE.DoubleSide,depthWrite:false}));gl.rotation.x=-Math.PI/2;grp.add(gl);
  grp.add(new THREE.PointLight(0x66ff44,.3,3).translateY(.3));
  grp.position.set(x!==undefined?x:(Math.random()-.5)*(river.width-4),-.3+Math.random()*1.2,z);
  grp.userData.hitRadius=.7;grp.userData.type='larva';grp.userData.bobOffset=Math.random()*6.28;grp.userData.collected=false;
  scene.add(grp);larvaList.push(grp);
}

// -- PARTICLES --
function spawnParticles(pos,color,count,spread,up){for(let i=0;i<count;i++){const p=new THREE.Mesh(new THREE.SphereGeometry(.03+Math.random()*.06,4,4),new THREE.MeshBasicMaterial({color,transparent:true,opacity:1,depthWrite:false}));p.position.copy(pos);p.userData.vel=new THREE.Vector3((Math.random()-.5)*spread,Math.random()*(up||2)+.5,(Math.random()-.5)*spread);p.userData.life=1;p.userData.decay=.6+Math.random()*1.2;scene.add(p);particles.push(p)}}
function spawnBubbles(pos,count){for(let i=0;i<count;i++){const b=new THREE.Mesh(new THREE.SphereGeometry(.02+Math.random()*.05,6,6),new THREE.MeshBasicMaterial({color:0xaaddff,transparent:true,opacity:.5+Math.random()*.3,depthWrite:false}));b.position.copy(pos);b.position.x+=(Math.random()-.5)*.4;b.position.z+=(Math.random()-.5)*.4;b.userData.vel=new THREE.Vector3((Math.random()-.5)*.3,1.5+Math.random()*2,(Math.random()-.5)*.3);b.userData.life=1;b.userData.decay=.7+Math.random()*.6;scene.add(b);particles.push(b)}}
function spawnWake(){if(gameState!=='playing')return;const r=new THREE.Mesh(new THREE.RingGeometry(.05,.15,8),new THREE.MeshBasicMaterial({color:0xaaddff,transparent:true,opacity:.3,side:THREE.DoubleSide,depthWrite:false}));r.rotation.x=-Math.PI/2;r.position.set(playerPos.x+(Math.random()-.5)*.3,.1,playerPos.z+1.2);r.userData.vel=new THREE.Vector3(0,0,0);r.userData.life=1;r.userData.decay=1.5;r.userData.isWake=true;scene.add(r);particles.push(r)}

// -- GAME LOGIC --
function updateLivesDisplay(){const c=document.getElementById('lives');c.innerHTML='<span class="lives-label">HP</span>';for(let i=0;i<3;i++){const p=document.createElement('div');p.className='life-pip'+(i>=lives?' lost':'');c.appendChild(p)}}
function showComboPopup(t){const p=document.createElement('div');p.className='combo-popup';p.textContent=t;p.style.top=(window.innerHeight*.35)+'px';document.body.appendChild(p);setTimeout(()=>p.remove(),1200)}
function hitObstacle(){if(invincibleTimer>0)return;lives--;updateLivesDisplay();invincibleTimer=2.5;screenShake=.6;multiplier=1;comboCount=0;const f=document.getElementById('flash-overlay');f.className='hit';setTimeout(()=>f.className='',250);spawnParticles(new THREE.Vector3(playerPos.x,playerPos.y+.3,playerPos.z),0xff3333,18,3,3);playSound('hit');if(lives<=0)gameOver()}
function collectLarva(l){if(l.userData.collected)return;l.userData.collected=true;larvaeCount++;comboCount++;comboTimer=3.5;if(comboCount>=3)multiplier=Math.min(multiplier+.25,5);if(comboCount===5){showComboPopup('x'+multiplier.toFixed(1)+' COMBO!');playSound('combo')}else if(comboCount===10){showComboPopup('AMAZING x'+multiplier.toFixed(1)+'!');playSound('combo')}else if(comboCount===15){showComboPopup('LEGENDARY!');playSound('combo')}score+=Math.floor(100*multiplier);spawnParticles(l.position.clone(),0x66ff44,12,2,2.5);const f=document.getElementById('flash-overlay');f.className='collect';setTimeout(()=>f.className='',150);playSound('collect');scene.remove(l);l.traverse(c=>{if(c.geometry)c.geometry.dispose();if(c.material)c.material.dispose()})}
function spawnContent(dt){spawnTimer+=dt;larvaSpawnTimer+=dt;difficultyTimer+=dt;if(difficultyTimer>15){obstacleFrequency=Math.min(obstacleFrequency+.02,1.2);baseSpeed=Math.min(baseSpeed+.2,20);difficultyTimer=0}if(spawnTimer>1/obstacleFrequency){const sz=playerPos.z-VD+30;createObstacle(sz);if(Math.random()<.25&&obstacleFrequency>.7)createObstacle(sz+(Math.random()-.5)*4);spawnTimer=0}if(larvaSpawnTimer>.8){const sz=playerPos.z-VD+40;if(Math.random()<.6){createLarva(sz);if(Math.random()<.35){const bx=(Math.random()-.5)*(river.width-5);for(let i=1;i<4+Math.floor(Math.random()*4);i++)createLarva(sz-i*2.5,bx+Math.sin(i*.5)*2)}}larvaSpawnTimer=0}}

// -- PLAYER --
function updatePlayer(dt){const ms=9;const li=(keys['d']||keys['arrowright']?1:0)-(keys['a']||keys['arrowleft']?1:0);playerVel.x+=(li*ms-playerVel.x)*dt*6;const fi=(keys['w']||keys['arrowup']?1:0)-(keys['s']||keys['arrowdown']?1:0);isSprinting=keys['shift']||keys['shiftleft'];const ts=baseSpeed+fi*4+(isSprinting?7:0);currentSpeed+=(ts-currentSpeed)*dt*3;currentSpeed=Math.max(4,Math.min(maxSpeed,currentSpeed));playerVel.x+=mouseX*4*dt;if((keys[' ']||keys['space'])&&!isJumping){isJumping=true;jumpVelocity=7;playSound('jump')}if(isJumping){jumpVelocity-=16*dt;playerPos.y+=jumpVelocity*dt;if(playerPos.y<=-.3){playerPos.y=-.3;isJumping=false;jumpVelocity=0;spawnBubbles(new THREE.Vector3(playerPos.x,.1,playerPos.z),10);playSound('splash')}}playerPos.x+=playerVel.x*dt;playerPos.z-=currentSpeed*dt;const bd=river.width/2-2;if(Math.abs(playerPos.x)>bd){playerPos.x=Math.sign(playerPos.x)*bd;playerVel.x*=-.4;spawnBubbles(new THREE.Vector3(playerPos.x,0,playerPos.z),4)}distance=Math.abs(playerPos.z);score+=Math.floor(currentSpeed*multiplier*dt*.5);if(comboTimer>0){comboTimer-=dt;if(comboTimer<=0){comboCount=0;multiplier=Math.max(1,multiplier-.25)}}if(invincibleTimer>0)invincibleTimer-=dt;if(screenShake>0)screenShake-=dt*2.5;if(Math.random()<.3+(currentSpeed/maxSpeed)*.4)spawnWake();if(Math.random()<(isSprinting?.5:.12))spawnBubbles(new THREE.Vector3(playerPos.x+(Math.random()-.5)*.4,playerPos.y+.1,playerPos.z+1.5),1)}

// -- CAMERA --
function updateCamera(dt,time){const tx=playerPos.x*.5+mouseX*2.5,ty=playerPos.y+5+mouseY*-1.2,tz=playerPos.z+9;camera.position.x+=(tx-camera.position.x)*dt*3.5;camera.position.y+=(ty-camera.position.y)*dt*2.8;camera.position.z+=(tz-camera.position.z)*dt*5;camera.lookAt(new THREE.Vector3(playerPos.x*.25+mouseX*2,playerPos.y-.5,playerPos.z-25));if(screenShake>0){camera.position.x+=(Math.random()-.5)*screenShake*.8;camera.position.y+=(Math.random()-.5)*screenShake*.4}camera.fov+=(60+(currentSpeed-baseSpeed)*1.2-camera.fov)*dt*2;camera.updateProjectionMatrix();ambientLights.forEach((l,i)=>{l.position.z=playerPos.z-10-i*25;l.position.x=Math.sin(time*.8+i*1.5)*7;l.position.y=3+Math.sin(time*.6+i)*1.5});lightRays.forEach((r,i)=>{r.position.z=playerPos.z-20-i*18;r.position.x=Math.sin(time*.3+i*2)*6;r.material.opacity=.03+Math.sin(time*.5+i)*.015})}

// -- COLLISIONS/CLEANUP --
function disposeThing(o){scene.remove(o);o.traverse(c=>{if(c.geometry)c.geometry.dispose();if(c.material){if(Array.isArray(c.material))c.material.forEach(m=>m.dispose());else c.material.dispose()}})}
function updateRiverSegments(){while(nextSegmentZ>playerPos.z-VD){createRiverSegment(nextSegmentZ);nextSegmentZ-=SL}river.segments=river.segments.filter(s=>{if(s.userData.z>playerPos.z+CD){disposeThing(s);return false}return true})}
function checkCollisions(){const pR=.6;obstacles=obstacles.filter(o=>{if(o.position.z>playerPos.z+CD){disposeThing(o);return false}const dx=playerPos.x-o.position.x,dz=playerPos.z-o.position.z,d=Math.sqrt(dx*dx+dz*dz);if(d<pR+o.userData.hitRadius*.8){if(playerPos.y>1.2)return true;hitObstacle()}return true});larvaList=larvaList.filter(l=>{if(l.userData.collected||l.position.z>playerPos.z+CD){if(!l.userData.collected)disposeThing(l);return false}const dx=playerPos.x-l.position.x,dz=playerPos.z-l.position.z,dy=playerPos.y-l.position.y;if(Math.sqrt(dx*dx+dz*dz+dy*dy)<pR+l.userData.hitRadius*1.1){collectLarva(l);return false}return true})}

// -- ANIMATIONS --
function updateParticles(dt){particles=particles.filter(p=>{p.userData.life-=p.userData.decay*dt;if(p.userData.life<=0){scene.remove(p);p.geometry.dispose();p.material.dispose();return false}if(p.userData.isWake){const s=1+(1-p.userData.life)*2;p.scale.set(s,s,s)}else{p.position.add(p.userData.vel.clone().multiplyScalar(dt));p.userData.vel.y-=4*dt}p.material.opacity=p.userData.life*.7;return true})}
function animateLarvae(time){larvaList.forEach(l=>{if(!l.userData.collected){const o=l.userData.bobOffset;l.position.y+=Math.sin(time*3.5+o)*.004;l.rotation.y=Math.sin(time*2+o)*.4;l.children.forEach((c,i)=>{if(i<6)c.position.x=Math.sin(time*5+i*.6+o)*.025})}})}
function animateObstacles(time){obstacles.forEach(o=>{if(o.userData.obstacleType==='whirlpool')o.traverse(c=>{if(c.name==='whirlRing')c.rotation.z=time*(2+c.userData.ringIndex*.5)});else if(o.userData.obstacleType==='heron')o.traverse(c=>{if(c.name==='heronWing')c.rotation.z=c.userData.side*(-.3+Math.sin(time*3)*.15)})})}
function animateEnvironment(time){river.segments.forEach(s=>{s.traverse(c=>{if(c.name==='seaweed'){const o=c.userData.swayOffset||0;c.rotation.z=Math.sin(time*1.2+o)*.18;c.rotation.x=Math.sin(time*.9+o+1)*.1}if(c.name==='reeds')c.rotation.z=Math.sin(time*.8+(c.userData.swayOffset||0))*.06;if(c.name==='lilypad'){const o=c.userData.bobOffset||0;c.position.y=.6+Math.sin(time*1.5+o)*.05;c.rotation.z=Math.sin(time*.7+o)*.03}})})}

// -- HUD --
function updateHUD(){document.getElementById('score').textContent=score.toLocaleString();document.getElementById('distance').textContent=Math.floor(distance)+'m';document.getElementById('larvae-display').innerHTML='&#x1FAB1; '+larvaeCount;const m=document.getElementById('multiplier');if(multiplier>1){m.textContent='x'+multiplier.toFixed(1);m.classList.add('pulse');setTimeout(()=>m.classList.remove('pulse'),150)}else m.textContent='';document.getElementById('speed-bar').style.width=Math.min(100,((currentSpeed-4)/(maxSpeed-4))*100)+'%'}
function updateFog(){const d=Math.min(distance/5000,1);scene.fog.density=.004+d*.003;scene.fog.color.setHSL(.58-d*.05,.5+d*.1,.12+d*.03);scene.background.copy(scene.fog.color).multiplyScalar(.6)}

// -- STATE --
function startGame(){initAudio();gameState='playing';score=0;distance=0;larvaeCount=0;lives=3;multiplier=1;comboCount=0;comboTimer=0;currentSpeed=baseSpeed=11;obstacleFrequency=.55;difficultyTimer=0;spawnTimer=0;larvaSpawnTimer=0;playerPos={x:0,y:-.3,z:0};playerVel={x:0,y:0};invincibleTimer=0;screenShake=0;isJumping=false;jumpVelocity=0;[...obstacles,...larvaList].forEach(o=>disposeThing(o));particles.forEach(p=>{scene.remove(p);p.geometry.dispose();p.material.dispose()});river.segments.forEach(s=>disposeThing(s));obstacles=[];larvaList=[];particles=[];river.segments=[];nextSegmentZ=50;createInitialRiver();updateLivesDisplay();document.getElementById('menu-screen').classList.add('hidden');document.getElementById('game-over').classList.remove('visible');document.getElementById('hud').classList.add('visible')}
function gameOver(){gameState='gameover';const n=score>bestScore;if(n){bestScore=score;localStorage.setItem('koiRunnerBest',bestScore.toString())}document.getElementById('final-score').textContent=score.toLocaleString();document.getElementById('final-distance').textContent=Math.floor(distance)+'m';document.getElementById('final-larvae').textContent=larvaeCount;const b=document.getElementById('best-score-display');b.textContent=n?'ðŸŽ‰ NEW BEST!':'Best: '+bestScore.toLocaleString();if(n)b.classList.add('go-new-best');else b.classList.remove('go-new-best');setTimeout(()=>document.getElementById('game-over').classList.add('visible'),600)}

// -- INPUT --
document.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;if(e.key===' ')e.preventDefault();if(!audioCtx)initAudio()});
document.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false});
document.getElementById('start-btn').addEventListener('click',startGame);
document.getElementById('retry-btn').addEventListener('click',startGame);
window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});

// -- MAIN LOOP --
function gameLoop(){
  requestAnimationFrame(gameLoop);
  const dt=Math.min(clock.getDelta(),.05),time=clock.getElapsedTime();
  if(gameState==='playing'){updatePlayer(dt);updateKoi(dt,time);updateCamera(dt,time);updateRiverSegments();spawnContent(dt);checkCollisions();updateParticles(dt);animateLarvae(time);animateObstacles(time);animateEnvironment(time);animateWater(time);updateHUD();updateFog()}
  else if(gameState==='menu'){camera.position.x=Math.sin(time*.25)*2;camera.position.y=5.5+Math.sin(time*.4)*.4;camera.position.z=10;camera.lookAt(0,0,-10);if(koiGroup){koiGroup.position.set(Math.sin(time*.4)*2,.3+Math.sin(time*.8)*.3,-3);koiGroup.rotation.y=Math.PI+Math.sin(time*.5)*.15;tailTime+=dt*4;koiGroup.traverse(c=>{if(c.name==='tailFin')c.rotation.x=Math.sin(tailTime*1.3)*.3})}animateWater(time);animateEnvironment(time)}
  else if(gameState==='gameover'){if(koiGroup){koiGroup.position.y+=Math.sin(time*1.5)*.002;koiGroup.rotation.z+=dt*.15}updateParticles(dt);animateWater(time)}
  renderer.render(scene,camera);
}

// -- BOOT --
initScene();gameLoop();
</script>
</body>
</html>
